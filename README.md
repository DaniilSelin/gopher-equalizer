# gopher-equalizer
## Описание проекта

gopher-equalizer — это обратный HTTP-прокси на Go, обеспечивающий балансировку нагрузки между несколькими экземплярами бэкенд-сервисов. Проект принимает входящие запросы и распределяет их равномерно между рабочими узлами, защищая систему от перегрузок. Для ограничения частоты запросов используется алгоритм «токен-бакета» (token bucket). перед запуском стоит посмотреть конфигурацию config/config.yml

## Архитектура проекта

### Диаграмма пакетов

![gopher-equalizer drawio](https://github.com/user-attachments/assets/8b109d85-462f-4bc3-801d-f0459018fb74)

#### Описание

    1. main - Точка входа приложения. Загружает конфиг, инициализирует логгер, БД, репозитории, сервисный     слой, маршрутизатор API и прокси. Запускает одновременно HTTP-API, прокси и фоновый health-checker.

    2. config — Отвечает за загрузку config.yml в структуру Config. Все остальные пакеты (main, balancer, proxy, service, repository, healthChecker, logger) получают *config.Config и читают из него свои параметры.

    3. logger — Инициализирует контекстный логгер. Сам логгер реализован на основе zap.Logger и хранится в контекст. Предоставляет функцию GetLoggerFromCtx для извлечения логгера из контекста.

    4. interfaces — Содержит набор общих интерфейсов:
        type IBucketRepository  // Create/Get/Update/Delete для token buckets  
        type IBucketService     // бизнес-логика лимитера + CRUD  
        type IBalancer          // NextBackend, ResetBackends  
        type IStrategy          // Next, ResetBackends
    Этот пает служит для связи пакетов между собой. Если слою требуется методы из другого слоя, то супертип слоя должен содержать в себе поля с интерфейсом необходимого типа с этими методами.
    
    5. models & errdefs — models: определяет сущность Bucket. errdefs: централизованный пакет ошибок, который возвращают репозиторий и сервис, а API/прокси превращают их в HTTP-коды. Хранит в себе станадртные ошибки общие дя всего балансировщика.

    6. repository — Реализует IBucketRepository через PostgreSQL (pgxpool). Миграции лежат в internal/database/migrations, таблица token_buckets.

    7. service — Реализует IBucketService: основная бизнес-логика token bucket, пополнение и потребление токенов, а так же CRUD опрации

    8. balancer — Обёртка над IStrategy. Balancer держит стратегию (RoundRobin и т.п.) и делегирует ей выбор следующего бэкенда. Позволяет сбрасывать пул серверов (ResetBackends) для health-checker’а.

    9. pkg/strategies — Стратегии балансировки: roundrobin.go, random.go и др. Помещен в именно этот пакет, так как код вполне переиспользуемый, и заменяемый. Тут можно реализовать другой алгоритм балансировки, главное соответствовать интерфейсу: IStrategy.

    10. transport/http
    
        api: маршруты для CRUD-API бакетов.
    
        proxy: ReverseProxy, который делает rate-limit и балансировку.
    
        healthCheck: фоновый проверяющий компонент, который пингует бэкенды.



### Прокси с балансировщиком

Компонент Proxy принимает HTTP-запросы клиентов и перенаправляет их к бэкенд-сервисам. Для распределения нагрузки может применяться алгоритм Round Robin, при котором запросы циклично идут по списку серверов. Балансировщик также скрывает внутренние IP-адреса бэкендов, обеспечивая дополнительный уровень безопасности и устойчивость системы.

### API для работы с бакетами

Сервис предоставляет REST API для управления «бакетами». Поддерживаются операции создания, получения списка и удаления бакетов. Данные при этом передаются в формате JSON.

### Здоровье бэкендов (health-checker)

Компонент проверки здоровья периодически опрашивает бэкенд-сервисы  и обновляет их статус. При обнаружении недоступности сервис помечается как «down», и прокси больше не отправляет на него запросы. Это предотвращает распределение трафика на неработающие узлы.

### Конфигурация и логгер

Настройки приложения хранятся в YAML-файле config/config.yml и загружаются при старте сервиса. В конфигурации указываются параметры подключения к PostgreSQL (host, port, user, password, dbname), порт сервера, список URL бэкендов, интервалы проверки здоровья, ограничения скорости, а также уровень логирования (например, info, debug и т.д.).

## Запуск

### Запуск через Docker Compose

    Выполните команду в корне проекта:

    docker-compose -f build/docker-compose.yml up --build

    Это создаст и запустит контейнеры (PostgreSQL и сам сервис). После успешного старта API будет доступно по указанному в конфиге порту (например, http://localhost:8080).

### Локальный запуск (без Docker)

Склонируйте репозиторий и перейдите в каталог проекта.

Установите зависимости:

    go mod tidy

Запустите PostgreSQL локально и создайте базу данных, параметры которой указаны в config/config.yml. Например:

    psql -U postgres -c "CREATE DATABASE equalizer;"

Проверьте и при необходимости отредактируйте настройки в config/config.yml (адрес БД, имя базы, порт сервера, список бэкендов и т.д.).

Запустите сервис:

    go run cmd/main.go

После запуска сервис будет слушать указанный в конфиге порт.

Примеры HTTP-запросов

Создание баскета -

    curl -i -X POST http://localhost:8080/buckets \
     -H "Content-Type: application/json" \
     -d '{
           "client_id": "test1234",
           "capacity":  15,
           "tokens":    5
         }'

Изменение емкости конкретного клиента -

    curl -i -X PUT http://localhost:8080/buckets/test123 \
     -H "Content-Type: application/json" \
     -d '{"capacity":10}'

Изменение кол-ва токенов конкретного клиента -

     curl -i -X PUT http://localhost:8080/buckets/test123      -H "Content-Type: application/json"      -d '{"tokens":0}'

Get по clientID -

    curl -i http://localhost:8080/buckets/test123

GET с плагинацией -

    curl -i "http://localhost:8080/buckets?limit=1&offset=0"


Удаление конкретного клиента - 

    curl -i -X DELETE http://localhost:8080/buckets/test123

## Тестирование

Юнит-тесты:

    go test ./...
