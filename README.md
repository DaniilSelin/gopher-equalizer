# gopher-equalizer
## Описание проекта

ДЛЯ АКТУАЛЬНОЙ ВЕРСИИ README стоит посмотреть - https://github.com/DaniilSelin/gopher-equalizer/edit/main/README.md.

gopher-equalizer — это обратный HTTP-прокси на Go, обеспечивающий балансировку нагрузки между несколькими экземплярами бэкенд-сервисов. Проект принимает входящие запросы и распределяет их равномерно между рабочими узлами, защищая систему от перегрузок. Для ограничения частоты запросов используется алгоритм «токен-бакета» (token bucket), реализованный, например, в пакете equalizer. 

## Архитектура проекта

### Прокси с балансировщиком

Компонент Proxy принимает HTTP-запросы клиентов и перенаправляет их к бэкенд-сервисам. Для распределения нагрузки может применяться алгоритм Round Robin, при котором запросы циклично идут по списку серверов. Балансировщик также скрывает внутренние IP-адреса бэкендов, обеспечивая дополнительный уровень безопасности и устойчивость системы.

### API для работы с бакетами

Сервис предоставляет REST API для управления «бакетами». Поддерживаются операции создания, получения списка и удаления бакетов. Данные при этом передаются в формате JSON.

### Здоровье бэкендов (health-checker)

Компонент проверки здоровья периодически опрашивает бэкенд-сервисы  и обновляет их статус. При обнаружении недоступности сервис помечается как «down», и прокси больше не отправляет на него запросы. Это предотвращает распределение трафика на неработающие узлы.

### Конфигурация и логгер

Настройки приложения хранятся в YAML-файле config/config.yml и загружаются при старте сервиса. В конфигурации указываются параметры подключения к PostgreSQL (host, port, user, password, dbname), порт сервера, список URL бэкендов, интервалы проверки здоровья, ограничения скорости, а также уровень логирования (например, info, debug и т.д.).

## Запуск

### Запуск через Docker Compose

    Выполните команду в корне проекта:

    docker-compose -f build/docker-compose.yml up --build

    Это создаст и запустит контейнеры (PostgreSQL и сам сервис). После успешного старта API будет доступно по указанному в конфиге порту (например, http://localhost:8080).

### Локальный запуск (без Docker)

Склонируйте репозиторий и перейдите в каталог проекта.

Установите зависимости:

    go mod tidy

Запустите PostgreSQL локально и создайте базу данных, параметры которой указаны в config/config.yml. Например:

    psql -U postgres -c "CREATE DATABASE equalizer;"

Проверьте и при необходимости отредактируйте настройки в config/config.yml (адрес БД, имя базы, порт сервера, список бэкендов и т.д.).

Запустите сервис:

    go run cmd/main.go

После запуска сервис будет слушать указанный в конфиге порт.

Примеры HTTP-запросов

Создание баскета -

    curl -i -X POST http://localhost:8080/buckets \
     -H "Content-Type: application/json" \
     -d '{
           "client_id": "test1234",
           "capacity":  15,
           "tokens":    5
         }'

Изменение емкости конкретного клиента -

    curl -i -X PUT http://localhost:8080/buckets/test123 \
     -H "Content-Type: application/json" \
     -d '{"capacity":10}'

Изменение кол-ва токенов конкретного клиента -

     curl -i -X PUT http://localhost:8080/buckets/test123      -H "Content-Type: application/json"      -d '{"tokens":0}'

Get по clientID -

    curl -i http://localhost:8080/buckets/test123

GET с плагинацией -

    curl -i "http://localhost:8080/buckets?limit=1&offset=0"


Удаление конкретного клиента - 

    curl -i -X DELETE http://localhost:8080/buckets/test123

## Тестирование

Юнит-тесты:

    go test ./...
